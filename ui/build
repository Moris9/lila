#!/bin/bash -e
export target=${1-dev}

mkdir -p public/compiled

ts_apps="common chess ceval game tree"
apps="site chat2 challenge2 notify2 learn insight editor puzzle round2 analyse lobby tournament tournamentSchedule simul perfStat dasher"

build_ts() {
  echo "build_ts" "$@"
  cd ui/$1
  rm -rf node_modules/types
  rm -rf node_modules/common
  rm -rf node_modules/chess
  npm install --no-optional
  npm run compile
  cd -
}

build() {
  echo "build" "$@"
  app=$1
  cd ui/$app
  rm -rf node_modules/types
  rm -rf node_modules/common
  rm -rf node_modules/chess
  rm -rf node_modules/game
  rm -rf node_modules/tree
  rm -rf node_modules/ceval
  npm install --no-optional && gulp $target
  cd -
}

if command -v parallel; then # parallel execution!
  export -f build_ts build
  parallel -j+2 --gnu --bar build_ts ::: $ts_apps
  parallel -j+2 --gnu --bar build ::: $apps
else # sequential execution
  for app in $ts_apps; do build_ts $app; done
  for app in $apps; do build $app; done
fi

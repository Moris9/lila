@(u: User, players: List[(Pov, lila.chat.MixedChat)], threads: List[lila.message.Thread], publicLines: List[lila.shutup.PublicLine], spy: lila.security.UserSpy, notes: List[lila.user.Note], history: List[lila.mod.Modlog], priv: Boolean)(implicit ctx: Context)

@import lila.hub.actorApi.shutup.PublicSource

@base.layout(
title = u.username + " communications",
responsive = true,
moreCss = responsiveCssTag("mod.communication")) {
<main id="communication" class="box box-pad">
  <h1>
    <div class="title">
      @userLink(u).toHtml communications
    </div>
    <div class="actions">
      @if(isGranted(_.ViewPrivateComms)) {
      @if(priv) {
      <a class="priv button active" href="@routes.Mod.communicationPublic(u.username)">PMs</a>
      } else {
      <a class="priv button" href="@routes.Mod.communicationPrivate(u.username)" title="View private messages. This will be logged in #commlog">PMs</a>
      }
      }
    </div>
  </h1>

  @if(history.nonEmpty) {
  <h2>Moderation history</h2>
  <div class="history">
    @history.map { e =>
    <div>
      @userIdLink(e.mod.some).toHtml <b>@e.showAction</b> @u.username @e.details @momentFromNowOnce(e.date).toHtml
    </div>
    }
  </div>
  }

  @if(notes.nonEmpty) {
  <h2>Notes from other users</h2>
  <div class="notes">
    @notes.map { note =>
    <div>
      @userIdLink(note.from.some).toHtml @momentFromNowOnce(note.date).toHtml: @richText(note.text)
    </div>
    }
  </div>
  }

  <h2>Dubious public chats</h2>
  @if(publicLines.isEmpty) {
  <strong>None!</strong>
  } else {
  <ul class="public_chats">
    @publicLines.reverse.map { line =>
    <li>
      @line.date.map(momentFromNowOnce(_).toHtml).getOrElse("[OLD]")
      @line.from.map {
      case PublicSource.Tournament(id) => { @tournamentLink(id).toHtml }
      case PublicSource.Simul(id) => { @views.html.simul.bits.link(id).toHtml }
      case PublicSource.Watcher(id) => { <a href="@routes.Round.watcher(id, "white")">Game #@id</a> }
      case PublicSource.Study(id) => { <a href="@routes.Study.show(id)">Study #@id</a> }
      }
      @line.text
    </li>
    }
  </ul>
  }

  @if(priv) {
  <h2>Recent private chats</h2>
  <div class="player_chats">
    @players.map {
    case (pov, chat) => {
    <div class="game">
      <a href="@routes.Round.player(pov.fullId)"
        @if(pov.game.fromFriend) {
          class="title friend_title" title="Friend"
        } else {
          class="title"
        }
        >
        @usernameOrAnon(pov.opponent.userId) â€“ @momentFromNowOnce(pov.game.movedAt).toHtml
      </a>
      <div class="chat">
        @chat.lines.map { line =>
        <div class="line @if(line.author.toLowerCase == u.id) { author }">
          @userIdLink(line.author.toLowerCase.some, withOnline = false, withTitle = false).toHtml
          @richText(line.text)
        </div>
        }
      </div>
    </div>
    }
    }
  </div>

  <div class="threads">
    <h2>Recent inbox messages</h2>
    @threads.map { thread =>
    <div class="thread">
      <p class="title">
        <strong>@thread.name</strong>
        @momentFromNowOnce(thread.createdAt).toHtml
        @userIdLink(thread.creatorId.some).toHtml -&gt; @userIdLink(thread.invitedId.some)
      </p>
      @thread.posts.map { post =>
      <div class="post @if(thread.isWrittenBy(post, u)) { author }">
        @userIdLink(thread.senderOf(post).some).toHtml
        @richText(post.text)
      </div>
      }
    </div>
    }
  </div>
  }
  <div class="alternate_accounts">
    <h2>Alternate accounts</h2>
    <table class="others slist">
      <thead>
        <tr>
          <th>@spy.otherUsers.size similar user(s)</th>
          <th>Same</th>
          <th>Games</th>
          <th>Marks</th>
          <th>IPban</th>
          <th>Closed</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        @spy.withMeSorted(u).map {
        case lila.security.UserSpy.OtherUser(o, byIp, byFp) => {
        <tr @if(o == u){class="same"}>
          <td>@userLink(o, withBestRating = true, params = "?mod").toHtml</td>
          <td>
            @if(o == u) { - } else {
            @List(byIp option "IP", byFp option "Print").flatten.mkString(", ")
            }
          </td>
          <td>@o.count.game.localize</td>
          <td>
            @if(o.engine){ENGINE}
            @if(o.booster){BOOSTER}
            @if(o.troll){SHADOWBAN}
          </td>
          <td>@if(o.ipBan){IPBAN}</td>
          <td>@if(o.disabled){CLOSED}</td>
          <td>@momentFromNowOnce(o.createdAt).toHtml</td>
        </tr>
        }
        }
      </tbody>
    </table>
  </div>
</div>
}.toHtml
